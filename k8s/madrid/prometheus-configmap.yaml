apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-server-conf
  namespace: madrid-p5
data:
  prom.yml: |
    global:
      scrape_interval: 15s
      external_labels:
        monitor: 'medioambiente_madrid'

    rule_files:
      - /etc/prometheus/prom.rules

    scrape_configs:
      - job_name: 'federate'
        scrape_interval: 15s
        honor_labels: true
        metrics_path: '/federate'
        params:
          'match[]':
            - '{job="castilla"}'   # Importante: Que coincida con el job_name que pusiste en los barrios
            - '{job="aravaca"}'    # Si no estás seguro, usa '{__name__=~".*"}' para traerlo todo
        static_configs:
          - targets:
            - 'prometheus-svc.castilla-p5:20000' # Puerto interno del servicio (no el NodePort)
            - 'prometheus-svc.aravaca-p5:20000'

  prom.rules: |
    groups:
    - name: madrid_rules
      rules:
      # Calculamos la media de Madrid basándonos en las medias de los barrios
      - record: temperatura_media_madrid
        expr: avg(temperatura_media)
        labels:
          job: 'madrid'
          unidades: 'centigrados'
      - record: humedad_media_madrid
        expr: avg(humedad_media)
        labels:
          job: 'madrid'
          unidades: '%'